AWSTemplateFormatVersion: 2010-09-09
Description: Create Minimal requirements for InfraPipe
Parameters:
  # Set the name of your AWS ENVIRONMENT here: dev/qa/prod
  InfraPipeEnv:
    Type: String
    Default: dev
    Description: Please enter the environment alias.
  # Set the name of Infrapipe USER here
  InfraPipeIamUsername:
    Type: String
    Default: terraform
    Description: Please enter the name of IAM user for the pipeline.
  # Set path for ROLES to be saved under
  InfraPipeIamPath:
    Type: String
    Default: /pipeline/
    Description: Please enter the path for IAM roles and users with beginning and ending with '/'.
  # Set path for SSM PARAMS to be saved under
  InfraPipeSsmPath:
    Type: String
    Default: security/pipeline
    Description: Please enter the path for SSM parameters without beginning and ending '/'.
Resources:
  # Create Infrapipe user
  InfraPipeIamUser:
    Type: 'AWS::IAM::User'
    Properties:
      Path:
        Ref: InfraPipeIamPath
      UserName: !Ref InfraPipeIamUsername
      Tags:
        - Key: Name
          Value: !Ref InfraPipeIamUsername
  # Grant read-only SSM permissions to Infrapipe User
  InfraPipeIamUserPolicy:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyName: InfraPipeIamUserPolicy-SSMReadonly
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Action: ssm:GetParameters
            Effect: Allow
            Resource: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${InfraPipeSSMParamPipelineRole}'
      Users:
        - !Ref InfraPipeIamUser
  # Grant Full Admin Access to Infrapipe role
  InfraPipeIamRolePolicyFullAdmin:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyName: InfraPipeIamRolePolicy-FullAdmin
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Action: '*'
            Effect: Allow
            Resource: '*'
      Roles:
        - !Ref InfraPipeIamRole
  # Allow Infrapipe user to assume pipeline role
  InfraPipeIamRolePolicyAssumePipelineRole:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyName: InfraPipeIamRolePolicy-AssumePipelineRole
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - 'sts:AssumeRole'
            Resource:
              - !GetAtt InfraPipeIamRole.Arn
        Users:
        - !Ref InfraPipeIamUser
  # Create Infrapipe role
  InfraPipeIamRole:
    Type: 'AWS::IAM::Role'
    Properties:
      RoleName: Pipeline-Ops
      Path:
        Ref: InfraPipeIamPath
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              AWS: !GetAtt InfraPipeIamUser.Arn
            Action:
              - 'sts:AssumeRole'
  # Create S3 bucket to store Terraform state as remote backend
  InfraPipeTfStateS3Bucket:
    Type: 'AWS::S3::Bucket'
    Properties:
      BucketName: !Sub 'tfstate-infrapipe-${InfraPipeEnv}-${AWS::AccountId}'
      # Add bucket encryption
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      # Enable bucket versioning to allow reverting back to previous TF state
      VersioningConfiguration:
        Status: Enabled
      # Deny public access to bucket
      PublicAccessBlockConfiguration:
        BlockPublicAcls: TRUE
        BlockPublicPolicy: TRUE
        IgnorePublicAcls: TRUE
        RestrictPublicBuckets: TRUE
  InfraPipeSSMParamS3BucketName:
    Type: 'AWS::SSM::Parameter'
    Properties:
      Description: Name of the S3 bucket storing Terraform state
      Name: !Sub '/${InfraPipeSsmPath}/${InfraPipeEnv}/AWS_TFSTATE_S3_BUCKET'
      Type: String
      Value: !Ref InfraPipeTfStateS3Bucket
  InfraPipeSSMParamS3BucketKey:
    Type: 'AWS::SSM::Parameter'
    Properties:
      Description: Key of the S3 bucket storing Terraform state
      Name: !Sub '/${InfraPipeSsmPath}/${InfraPipeEnv}/AWS_TFSTATE_S3_KEY'
      Type: String
      Value: terraform.tfstate
  InfraPipeSSMParamPipelineRole:
    Type: 'AWS::SSM::Parameter'
    Properties:
      Description: Name of Pipeline IAM Role
      Name: !Sub '/${InfraPipeSsmPath}/${InfraPipeEnv}/AWS_ASSUME_ROLE_ARN'
      Type: String
      Value: !GetAtt InfraPipeIamRole.Arn
